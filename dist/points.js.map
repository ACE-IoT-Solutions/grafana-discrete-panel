{"version":3,"sources":["../src/points.js"],"names":["_","DistinctPoints","name","changes","legendInfo","last","asc","ts","val","start","ms","push","console","log","length","ctrl","reverse","range","to","until","transitionCount","valToInfo","lastTS","legendCount","maxLegendSize","panel","legendMaxValues","i","pt","s","e","from","has","v","count","elapsed","forEach","value","per","distinctValuesCount","size","isTimeline","orderBy"],"mappings":"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","file":"points.js","sourcesContent":["import _ from \"lodash\";\r\n\r\nexport default class DistinctPoints {\r\n\r\n  constructor(name) {\r\n    this.name = name;\r\n    this.changes = [];\r\n    this.legendInfo = [];\r\n\r\n    // last point we added\r\n    this.last = null;\r\n    this.asc = false;\r\n  }\r\n\r\n  // ts numeric ms,\r\n  // val is the normalized value\r\n  add( ts, val ) {\r\n    if(this.last == null) {\r\n      this.last = {\r\n        val: val,\r\n        start: ts,\r\n        ms: 0\r\n      };\r\n      this.changes.push(this.last);\r\n    }\r\n    else if(ts == this.last.ts ) {\r\n      console.log('skip point with duplicate timestamp', ts, val);\r\n      return;\r\n    }\r\n    else {\r\n      if(this.changes.length === 1) {\r\n        this.asc = ts > this.last.start;\r\n      }\r\n\r\n      if( (ts > this.last.start) != this.asc ) {\r\n        console.log('skip out of order point', ts, val);\r\n        return;\r\n      }\r\n\r\n      // Same value\r\n      if(val == this.last.val) {\r\n        if(!this.asc) {\r\n          this.last.start = ts;\r\n        }\r\n      }\r\n      else {\r\n        this.last = {\r\n          val: val,\r\n          start: ts,\r\n          ms: 0\r\n        };\r\n        this.changes.push(this.last);\r\n      }\r\n    }\r\n  }\r\n\r\n  finish(ctrl) {\r\n    if(this.changes.length<1) {\r\n      console.log( \"no points found!\" );\r\n      return;\r\n    }\r\n\r\n\r\n    if(!this.asc) {\r\n      this.last = this.changes[0];\r\n      _.reverse(this.changes);\r\n    }\r\n\r\n    // Add a point beyond the controls\r\n    if(this.last.start < ctrl.range.to) {\r\n      var until = ctrl.range.to+1;\r\n      // var now = Date.now();\r\n      // if(this.last.start < now && ctrl.range.to > now) {\r\n      //   until = now;\r\n      // }\r\n\r\n      // This won't be shown, but will keep the count consistent\r\n      this.changes.push( {\r\n        val: this.last.val,\r\n        start: until,\r\n        ms: 0\r\n      });\r\n    }\r\n\r\n    this.transitionCount = 0;\r\n    var valToInfo = {};\r\n    var lastTS = 0;\r\n    var legendCount = 0;\r\n    var maxLegendSize = ctrl.panel.legendMaxValues;\r\n    if(!maxLegendSize) {\r\n      maxLegendSize = 20;\r\n    }\r\n    var last = this.changes[0];\r\n    for(var i=1; i<this.changes.length; i++) {\r\n      var pt = this.changes[i];\r\n\r\n      var s = last.start;\r\n      var e = pt.start;\r\n      if( s < ctrl.range.from ) {\r\n        s = ctrl.range.from;\r\n      }\r\n      else if(s<ctrl.range.to) {\r\n        this.transitionCount++;\r\n      }\r\n\r\n      if( e > ctrl.range.to ) {\r\n        e = ctrl.range.to;\r\n      }\r\n\r\n      last.ms = e - s;\r\n      if(last.ms>0) {\r\n        if(_.has(valToInfo, last.val)) {\r\n          var v = valToInfo[last.val];\r\n          v.ms += last.ms;\r\n          v.count++;\r\n        }\r\n        else {\r\n          valToInfo[last.val] = { 'val': last.val, 'ms': last.ms, 'count':1 };\r\n          legendCount++;\r\n        }\r\n      }\r\n      last = pt;\r\n    }\r\n\r\n    var elapsed = ctrl.range.to - ctrl.range.from;\r\n    this.elapsed = elapsed;\r\n\r\n    _.forEach(valToInfo, (value) => {\r\n      value.per = (value.ms/elapsed);\r\n      this.legendInfo.push( value );\r\n    });\r\n    this.distinctValuesCount = _.size(this.legendInfo);\r\n\r\n\r\n    if(!ctrl.isTimeline) {\r\n      this.legendInfo = _.orderBy( this.legendInfo, ['ms'], ['desc'] );\r\n    }\r\n    //console.log( \"FINISH\", this );\r\n  }\r\n}\r\n"]}