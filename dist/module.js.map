{"version":3,"sources":["../src/module.js"],"names":["config","CanvasPanelCtrl","_","moment","angular","DiscretePanelCtrl","$scope","$injector","$q","timeSrv","data","panelDefaults","rowHeight","valueMaps","value","op","text","mappingTypes","name","rangeMaps","from","to","colorMaps","color","writeLastValue","writeAllValues","writeMetricNames","showLegend","showLegendPercent","defaults","panel","events","on","onInitEditMode","bind","onRender","onDataReceived","onDataError","onRefresh","updateColorInfo","err","console","log","addEditorTab","editorTabIndex","refresh","context","rect","wrap","getBoundingClientRect","rows","length","height","width","canvas","ctx","lineWidth","textBaseline","top","range","timeRange","elapsed","forEach","metric","centerV","fillStyle","fillRect","font","textAlign","fillText","lastBS","point","changes","i","start","xt","Math","max","x","getColor","val","beginPath","moveTo","lineTo","stroke","mouse","position","down","next","ts","globalCompositeOperation","fill","xmin","min","xmax","strokeStyle","pos","ms","time","body","dashboard","formatDate","duration","humanize","$tooltip","html","place_tt","pageX","pageY","info","count","detach","stats","isNumber","map","parseFloat","isNull","isNil","isString","toString","has","colorMap","palet","abs","hashCode","letters","split","floor","random","str","hash","char","charCodeAt","pt","end","res","valToInfo","tooManyValues","v","dataList","$","css","target","legendInfo","push","last","datapoints","norm","formatValue","_processLast","nullText","per","splice","round","index","indexOf","cm","m","render","what","randomColor","rangeMap","evt","hover","j","hoverPoint","showTooltip","where","utc","up","setTime","templateUrl"],"mappings":"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","file":"module.js","sourcesContent":["import config from 'app/core/config';\r\n\r\nimport {CanvasPanelCtrl} from './canvas-metric';\r\n\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\nimport angular from 'angular';\r\n\r\nclass DiscretePanelCtrl extends CanvasPanelCtrl {\r\n\r\n  constructor($scope, $injector, $q, timeSrv) {\r\n    super($scope, $injector, $q, timeSrv);\r\n\r\n    this.data = null;\r\n\r\n    // Set and populate defaults\r\n    var panelDefaults = {\r\n      rowHeight: 50,\r\n      valueMaps: [\r\n        { value: 'null', op: '=', text: 'N/A' }\r\n      ],\r\n      mappingTypes: [\r\n        {name: 'value to text', value: 1},\r\n        {name: 'range to text', value: 2},\r\n      ],\r\n      rangeMaps: [\r\n        { from: 'null', to: 'null', text: 'N/A' }\r\n      ],\r\n      colorMaps: [\r\n        { text: 'N/A', color: '#CCC' }\r\n      ],\r\n      writeLastValue: true,\r\n      writeAllValues: false,\r\n      writeMetricNames: false,\r\n      showLegend: true,\r\n      showLegendPercent: true\r\n    };\r\n    _.defaults(this.panel, panelDefaults);\r\n\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('render', this.onRender.bind(this));\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n    this.events.on('data-error', this.onDataError.bind(this));\r\n    this.events.on('refresh', this.onRefresh.bind(this));\r\n\r\n    this.updateColorInfo();\r\n  }\r\n\r\n  onDataError(err) {\r\n    console.log(\"onDataError\", err);\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.addEditorTab('Options', 'public/plugins/natel-discrete-panel/editor.html',1);\r\n    this.addEditorTab('Colors', 'public/plugins/natel-discrete-panel/colors.html',3);\r\n    this.addEditorTab('Mappings', 'public/plugins/natel-discrete-panel/mappings.html', 4);\r\n    this.editorTabIndex = 1;\r\n    this.refresh();\r\n  }\r\n\r\n  onRender() {\r\n    if( !(this.context) ) {\r\n      console.log( 'No context!');\r\n      return;\r\n    }\r\n\r\n    if(this.data == null) {\r\n      console.log( 'No data!');\r\n      return;\r\n    }\r\n\r\n //   console.log( 'render', this.data);\r\n\r\n    var rect = this.wrap.getBoundingClientRect();\r\n\r\n    var rows = this.data.length;\r\n    var rowHeight = this.panel.rowHeight;\r\n\r\n    var height = rowHeight * rows;\r\n    var width = rect.width;\r\n    this.canvas.width = width;\r\n    this.canvas.height = height;\r\n\r\n    var ctx = this.context;\r\n    ctx.lineWidth = 1;\r\n    ctx.textBaseline = 'middle';\r\n\r\n    // ctx.shadowOffsetX = 1;\r\n    // ctx.shadowOffsetY = 1;\r\n    // ctx.shadowColor = \"rgba(0,0,0,0.3)\";\r\n    // ctx.shadowBlur = 3;\r\n\r\n    var top = 0;\r\n\r\n    var range = this.timeSrv.timeRange();\r\n    var elapsed = range.to - range.from;\r\n\r\n    _.forEach(this.data, (metric) => {\r\n      var centerV = top + (rowHeight/2);\r\n\r\n      // The no-data line\r\n      ctx.fillStyle = '#333333';\r\n      ctx.fillRect(0, top, width, rowHeight);\r\n\r\n      if(!this.panel.writeMetricNames) {\r\n        ctx.fillStyle = \"#111111\";\r\n        ctx.font = '24px \"Open Sans\", Helvetica, Arial, sans-serif';\r\n        ctx.textAlign = 'left';\r\n        ctx.fillText(\"No Data\", 10, centerV);\r\n      }\r\n\r\n      var lastBS = 0;\r\n      var point = metric.changes[0];\r\n      for(var i=0; i<metric.changes.length; i++) {\r\n        point = metric.changes[i];\r\n        if(point.start <= range.to) {\r\n          var xt = Math.max( point.start - range.from, 0 );\r\n          point.x = (xt / elapsed) * width;\r\n          ctx.fillStyle = this.getColor( point.val );\r\n          ctx.fillRect(point.x, top, width, rowHeight);\r\n\r\n          if(this.panel.writeAllValues) {\r\n            ctx.fillStyle = \"#000000\";\r\n            ctx.font = '24px \"Open Sans\", Helvetica, Arial, sans-serif';\r\n            ctx.textAlign = 'left';\r\n\r\n            ctx.fillText(point.val, point.x+7, centerV);\r\n          }\r\n          lastBS = point.x;\r\n        }\r\n      }\r\n\r\n\r\n\r\n      if(top>0) {\r\n        ctx.fillStyle = \"#DDDDDD\";\r\n        ctx.beginPath();\r\n        ctx.moveTo(0, top);\r\n        ctx.lineTo(width, top);\r\n        ctx.stroke();\r\n      }\r\n\r\n      ctx.fillStyle = \"#000000\";\r\n      ctx.font = '24px \"Open Sans\", Helvetica, Arial, sans-serif';\r\n\r\n      if(this.panel.writeMetricNames && (this.mouse.position==null || this.mouse.position.x > 200 ) ) {\r\n        ctx.textAlign = 'left';\r\n        ctx.fillText( metric.name, 10, centerV);\r\n      }\r\n\r\n      ctx.textAlign = 'right';\r\n\r\n      if( this.mouse.down == null ) {\r\n        if( this.mouse.position != null ) {\r\n          point = metric.changes[0];\r\n          var next = null;\r\n          for(var i=0; i<metric.changes.length; i++) {\r\n            if(metric.changes[i].start > this.mouse.position.ts) {\r\n              next = metric.changes[i];\r\n              break;\r\n            }\r\n            point = metric.changes[i];\r\n          }\r\n\r\n          // Fill canvas using 'destination-out' and alpha at 0.05\r\n          ctx.globalCompositeOperation = 'destination-out';\r\n          ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\r\n          ctx.beginPath();\r\n          ctx.fillRect(0, top, point.x, rowHeight);\r\n          ctx.fill();\r\n\r\n          if(next != null) {\r\n            ctx.beginPath();\r\n            ctx.fillRect(next.x, top, width, rowHeight);\r\n            ctx.fill();\r\n          }\r\n          ctx.globalCompositeOperation = 'source-over';\r\n\r\n          // Now Draw the value\r\n          ctx.fillStyle = \"#000000\";\r\n          ctx.font = '24px \"Open Sans\", Helvetica, Arial, sans-serif';\r\n          ctx.textAlign = 'left';\r\n          ctx.fillText( point.val, point.x+10, centerV);\r\n\r\n\r\n          // ctx.fillText( point.val, this.mouse.position.x-10, centerV);\r\n\r\n          // if(point.ms > 2) {\r\n          //   ctx.textAlign = 'left';\r\n          //   ctx.font = '18px \"Open Sans\", Helvetica, Arial, sans-serif';\r\n\r\n          //   var msg = moment.duration( point.ms ).humanize(false);\r\n          //   ctx.fillText(msg, this.mouse.position.x+10, centerV);\r\n          // }\r\n        }\r\n        else if( this.panel.writeLastValue ) {\r\n          ctx.fillText( point.val, width-10, centerV );\r\n        }\r\n      }\r\n\r\n      top += rowHeight;\r\n    });\r\n\r\n\r\n    if(this.mouse.position != null ) {\r\n      if(this.mouse.down != null) {\r\n        var xmin = Math.min( this.mouse.position.x, this.mouse.down.x);\r\n        var xmax = Math.max( this.mouse.position.x, this.mouse.down.x);\r\n\r\n        // Fill canvas using 'destination-out' and alpha at 0.05\r\n        ctx.globalCompositeOperation = 'destination-out';\r\n        ctx.fillStyle = \"rgba(255, 255, 255, 0.6)\";\r\n        ctx.beginPath();\r\n        ctx.fillRect(0, 0, xmin, height);\r\n        ctx.fill();\r\n\r\n        ctx.beginPath();\r\n        ctx.fillRect(xmax, 0, width, height);\r\n        ctx.fill();\r\n        ctx.globalCompositeOperation = 'source-over';\r\n      }\r\n      else {\r\n        ctx.strokeStyle = '#111';\r\n        ctx.beginPath();\r\n        ctx.moveTo(this.mouse.position.x, 0);\r\n        ctx.lineTo(this.mouse.position.x, height);\r\n        ctx.lineWidth = 3;\r\n        ctx.stroke();\r\n\r\n        ctx.beginPath();\r\n        ctx.moveTo(this.mouse.position.x, 0);\r\n        ctx.lineTo(this.mouse.position.x, height);\r\n        ctx.strokeStyle = '#e22c14';\r\n        ctx.lineWidth = 2;\r\n        ctx.stroke();\r\n      }\r\n    }\r\n  }\r\n\r\n  showTooltip(pos, point) {\r\n    var from = point.start;\r\n    var to = point.start + point.ms;\r\n    var time = point.ms;\r\n    var val = point.val;\r\n\r\n    if(this.mouse.down != null) {\r\n      from = Math.min(this.mouse.down.ts, this.mouse.position.ts);\r\n      to   = Math.max(this.mouse.down.ts, this.mouse.position.ts);\r\n      time = to - from;\r\n      val = \"Zoom To:\";\r\n    }\r\n\r\n    var body = '<div class=\"graph-tooltip-time\">'+ val + '</div>';\r\n    \r\n    body += \"<center>\"\r\n    body += this.dashboard.formatDate( moment(from) ) + \"<br/>\";\r\n    body += \"to<br/>\";\r\n    body += this.dashboard.formatDate( moment(to) ) + \"<br/><br/>\";\r\n    body += moment.duration(time).humanize() + \"<br/>\";\r\n    body += \"</center>\"\r\n\r\n    this.$tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\r\n  };\r\n\r\n\r\n  showLegandTooltip(pos, info) {\r\n    var body = '<div class=\"graph-tooltip-time\">'+ info.val +'</div>';\r\n    \r\n    body += \"<center>\";\r\n    if(info.count > 1) {\r\n      body += info.count + \" times<br/>for<br/>\";\r\n    }\r\n    body += moment.duration(info.ms).humanize();\r\n    if(info.count > 1) {\r\n      body += \"<br/>total\";\r\n    }\r\n    body += \"</center>\"\r\n\r\n    this.$tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\r\n  }\r\n\r\n  clearTT() {\r\n    this.$tooltip.detach(); \r\n  }\r\n\r\n  formatValue(val, stats) {\r\n\r\n    if(_.isNumber(val) && this.panel.rangeMaps) {\r\n      for (var i = 0; i < this.panel.rangeMaps.length; i++) {\r\n        var map = this.panel.rangeMaps[i];\r\n\r\n        // value/number to range mapping\r\n        var from = parseFloat(map.from);\r\n        var to = parseFloat(map.to);\r\n        if (to >= val && from <= val) {\r\n          return map.text;\r\n        }\r\n      }\r\n    }\r\n\r\n    var isNull = _.isNil(val);\r\n    if(!isNull && _.isString(val)) {\r\n      val = val.toString(); // convert everything to a string\r\n    }\r\n\r\n    for (var i = 0; i < this.panel.valueMaps.length; i++) {\r\n      var map = this.panel.valueMaps[i];\r\n      // special null case\r\n      if (map.value === 'null') {\r\n        if (isNull) {\r\n          return map.text;\r\n        }\r\n        continue;\r\n      }\r\n\r\n      if(val == map.value) {\r\n        return map.text;\r\n      }\r\n    }\r\n\r\n    if(isNull) {\r\n      return \"null\";\r\n    }\r\n    return val;\r\n  }\r\n\r\n  getColor(val) {\r\n    if(_.has(this.colorMap, val)) {\r\n      return this.colorMap[val];\r\n    }\r\n\r\n    var palet = [\r\n      '#FF4444',\r\n      '#9933CC',\r\n      '#32D1DF',\r\n      '#ed2e18',\r\n      '#CC3900',\r\n      '#F79520',\r\n      '#33B5E5'\r\n    ];\r\n\r\n    return palet[ Math.abs(this.hashCode(val+'')) % palet.length ];\r\n  }\r\n\r\n  randomColor() {\r\n    var letters = 'ABCDE'.split('');\r\n    var color = '#';\r\n    for (var i=0; i<3; i++ ) {\r\n        color += letters[Math.floor(Math.random() * letters.length)];\r\n    }\r\n    return color;\r\n  }\r\n\r\n  hashCode(str){\r\n    var hash = 0;\r\n    if (str.length == 0) return hash;\r\n    for (var i = 0; i < str.length; i++) {\r\n      var char = str.charCodeAt(i);\r\n      hash = ((hash<<5)-hash)+char;\r\n      hash = hash & hash; // Convert to 32bit integer\r\n    }\r\n    return hash;\r\n  }\r\n\r\n  //-----------\r\n\r\n  _processLast(pt, end, res, valToInfo) {\r\n    pt.ms = (end - pt.start);\r\n    if(!res.tooManyValues) {\r\n      if(_.has(valToInfo, pt.val)) {\r\n        var v = valToInfo[pt.val];\r\n        v.ms += pt.ms;\r\n        v.count++;\r\n      }\r\n      else {\r\n        valToInfo[pt.val] = { 'val': pt.val, 'ms': pt.ms, 'count':1 };\r\n      }\r\n      res.tooManyValues = (valToInfo.length > 20);\r\n    }\r\n  }\r\n\r\n  onDataReceived(dataList) {\r\n    $(this.canvas).css( 'cursor', 'pointer' );\r\n\r\n    var range = this.timeSrv.timeRange();\r\n    var elapsed = range.to - range.from;\r\n    var data = [];\r\n    _.forEach(dataList, (metric) => {\r\n      var valToInfo = {};\r\n      var res = { \r\n        name: metric.target, \r\n        changes: [],\r\n        tooManyValues: false,\r\n        legendInfo: [] };\r\n      data.push( res );\r\n\r\n      var last = null;\r\n      _.forEach(metric.datapoints, (point) => {\r\n\r\n        var norm = this.formatValue(point[0]);\r\n        if(last==null || norm != last.val) {\r\n          var pt = {\r\n            val: norm,\r\n            start: point[1],\r\n            ms: 0 // time in this state\r\n          }\r\n\r\n          if(last!=null) {\r\n            this._processLast( last, pt.start, res, valToInfo);\r\n          };\r\n\r\n          res.changes.push(pt);\r\n          last = pt;\r\n        }\r\n      });\r\n\r\n      if(last!=null) {\r\n        this._processLast( last, range.to, res, valToInfo);\r\n      };\r\n\r\n      // Remove null from the legend if it is the first value and small (common for influx queries)\r\n      var nullText = this.formatValue(null);\r\n      if( res.changes.length > 1 && _.has(valToInfo, nullText ) ) {\r\n        var info = valToInfo[nullText];\r\n        if(info.count == 1 ) { \r\n          var per = (info.ms/elapsed);\r\n          if( per < .02 ) {\r\n            if(res.changes[0].val == nullText) {\r\n              console.log( 'Removing null', info );\r\n              delete valToInfo[nullText];\r\n\r\n              res.changes[1].start = res.changes[0].start;\r\n              res.changes[1].ms += res.changes[0].ms;\r\n              res.changes.splice(0, 1);\r\n            }\r\n          }\r\n        }\r\n      }\r\n      _.forEach(valToInfo, (value) => {\r\n        value.per = Math.round( (value.ms/elapsed)*100 );\r\n        res.legendInfo.push( value );\r\n      });\r\n    });\r\n    this.data = data;\r\n    \r\n    this.onRender();\r\n\r\n    //console.log( 'data', dataList, this.data);\r\n  }\r\n\r\n  removeColorMap(map) {\r\n    var index = _.indexOf(this.panel.colorMaps, map);\r\n    this.panel.colorMaps.splice(index, 1);\r\n    this.updateColorInfo();\r\n  };\r\n\r\n  updateColorInfo() {\r\n    var cm = {};\r\n    for(var i=0; i<this.panel.colorMaps.length; i++) {\r\n      var m = this.panel.colorMaps[i];\r\n      if(m.text) {\r\n        cm[m.text] = m.color;\r\n      }\r\n    }\r\n    this.colorMap = cm;\r\n    this.render();\r\n  }\r\n\r\n  addColorMap(what) {\r\n    if(what == 'curent') {\r\n      _.forEach(this.data, (metric) => {\r\n        if(metric.legendInfo) {\r\n          _.forEach(metric.legendInfo, (info) => {\r\n            if(!_.has(info.val)) {\r\n              this.panel.colorMaps.push({text: info.val, color: this.getColor(info.val) });\r\n            }\r\n          });\r\n        }\r\n      });\r\n    }\r\n    else {\r\n      this.panel.colorMaps.push({text: '???', color: this.randomColor() });\r\n    }\r\n    this.updateColorInfo();\r\n  }\r\n\r\n  removeValueMap(map) {\r\n    var index = _.indexOf(this.panel.valueMaps, map);\r\n    this.panel.valueMaps.splice(index, 1);\r\n    this.render();\r\n  };\r\n\r\n  addValueMap() {\r\n    this.panel.valueMaps.push({value: '', op: '=', text: '' });\r\n  }\r\n\r\n  removeRangeMap(rangeMap) {\r\n    var index = _.indexOf(this.panel.rangeMaps, rangeMap);\r\n    this.panel.rangeMaps.splice(index, 1);\r\n    this.render();\r\n  };\r\n\r\n  addRangeMap() {\r\n    this.panel.rangeMaps.push({from: '', to: '', text: ''});\r\n  }\r\n\r\n  onConfigChanged() {\r\n    console.log( \"Config changed...\");\r\n    this.render();\r\n  }\r\n\r\n  //------------------\r\n  // Mouse Events\r\n  //------------------\r\n\r\n  onMouseMoved(evt) {\r\n    if(this.data) {\r\n      var range = this.timeSrv.timeRange();\r\n      var hover = null;\r\n      for(var j=0; j<this.data.length; j++) {\r\n        if(true) { // TODO, pick the right one!\r\n          hover = this.data[j].changes[0];\r\n          for(var i=0; i<this.data[j].changes.length; i++) {\r\n            if(this.data[j].changes[i].start > this.mouse.position.ts) {\r\n              break;\r\n            }\r\n            hover = this.data[j].changes[i];\r\n          } \r\n        }\r\n      }\r\n      this.hoverPoint = hover;\r\n      this.showTooltip( evt, hover );\r\n    }\r\n    else {\r\n      this.$tooltip.detach(); // make sure it is hidden\r\n    }\r\n    this.onRender(); // refresh the view\r\n  }\r\n\r\n  onMouseClicked(where) {\r\n    var pt = this.hoverPoint;\r\n    var range = {from: moment.utc(pt.start), to: moment.utc(pt.start+pt.ms) };\r\n    console.log( \"CLICK\", up, pt, range );\r\n    this.timeSrv.setTime(range);\r\n    $(this.canvas).css( 'cursor', 'wait' );\r\n  }\r\n\r\n  onMouseSelectedRange(range) {\r\n    this.timeSrv.setTime(range);\r\n    $(this.canvas).css( 'cursor', 'wait' ); \r\n  }\r\n\r\n}\r\nDiscretePanelCtrl.templateUrl = 'module.html';\r\n\r\nexport {\r\n  DiscretePanelCtrl as PanelCtrl\r\n};\r\n\r\n\r\n"]}